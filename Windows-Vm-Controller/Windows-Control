pipeline {
    agent any

    environment {
        TF_STATE_BUCKET = "my-terraform-state-bucket-425"
        TF_STATE_KEY = "terraform.tfstate"
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        WINDOWS_USER = "Administrator"
        PRIVATE_KEY = "C:/Ansible-keys/terraformkeypair.pem"
        SCRIPT_DEST = "C:/Scripts"
        REPO_URL = "https://github.com/SowmithAccenture/terraformpractice.git"
        BRANCH = "main"
    }

    stages {
        stage('Get Windows Instance IPs from Terraform State') {
            steps {
                script {
                    // Fetch the latest terraform state from S3
                    bat "\"C:\\Program Files\\Git\\bin\\bash.exe\" -c 'AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} aws s3 cp s3://${TF_STATE_BUCKET}/${TF_STATE_KEY} terraform.tfstate'"

                    // Extract Windows instance IPs from the terraform state file
                    def windowsIPs = powershell(returnStdout: true, script: """
                        \$tfState = Get-Content terraform.tfstate -Raw | ConvertFrom-Json
                        \$windowsIPs = \$tfState.resources | Where-Object { \$_.'type' -eq 'aws_instance' } | ForEach-Object { \$_.'instances' } | ForEach-Object { \$_[0].'attributes'.'public_ip' }
                        \$windowsIPs -join ', '
                    """).trim()

                    echo "Extracted Windows VM IPs: ${windowsIPs}"
                    env.WINDOWS_IPS = windowsIPs
                }
            }
        }

        stage('Clone PowerShell Scripts from GitHub') {
            steps {
                script {
                    bat "\"C:\\Program Files\\Git\\bin\\bash.exe\" -c 'rm -rf terraformpractice && git clone --single-branch -b ${BRANCH} ${REPO_URL}'"
                }
            }
        }

        stage('Copy Scripts to Windows VMs') {
            steps {
                script {
                    def windowsIPList = env.WINDOWS_IPS.split(', ')
                    windowsIPList.each { ip ->
                        bat """
                            scp -i ${PRIVATE_KEY} -o StrictHostKeyChecking=no -r Windows-Vm-Controller ${WINDOWS_USER}@${ip}:${SCRIPT_DEST}
                        """
                    }
                }
            }
        }

        stage('Execute PowerShell Script on Windows VMs') {
            steps {
                script {
                    def windowsIPList = env.WINDOWS_IPS.split(', ')
                    windowsIPList.each { ip ->
                        bat """
                            ssh -i ${PRIVATE_KEY} -o StrictHostKeyChecking=no ${WINDOWS_USER}@${ip} "powershell.exe -ExecutionPolicy Bypass -File ${SCRIPT_DEST}/create_user.ps1"
                        """
                    }
                }
            }
        }
    }
}

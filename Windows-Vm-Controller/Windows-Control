pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        TF_STATE_BUCKET = "my-terraform-state-bucket-425"
        TF_STATE_KEY = "terraform.tfstate"
        S3_SCRIPT_PATH = "s3://my-terraform-state-bucket-425"
        ADMIN_USERNAME = "Administrator"
    }

    stages {
          stage('Fetch Windows VM IPs from Terraform State') {
            steps {
                script {
                    echo "Fetching Windows VM IPs from Terraform State..."
                    def jsonOutput = sh(script: """
                        aws s3 cp s3://$S3_BUCKET/terraform.tfstate terraform.tfstate --quiet
                        cat terraform.tfstate | jq -r '.resources[] | select(.type=="aws_instance") | .instances[] | select(.attributes.platform=="windows") | .attributes.public_ip'
                    """, returnStdout: true).trim()
                    
                    if (jsonOutput) {
                        env.WINDOWS_IPS = jsonOutput.split("\n").join(" ")
                        echo "Windows VM IPs: ${env.WINDOWS_IPS}"
                    } else {
                        error "No Windows VM IPs found in Terraform state!"
                    }
                }
            }
        }

        stage('Decrypt Windows Passwords') {
            steps {
                script {
                    def ipList = env.WINDOWS_IPS.split(' ')
                    def passwords = [:]

                    for (ip in ipList) {
                        echo "Decrypting password for ${ip}..."
                        
                        def password = powershell(returnStdout: true, script: """
                            aws ec2 get-password-data --instance-id "\$(aws ec2 describe-instances --filters "Name=ip-address,Values=${ip}" --query "Reservations[*].Instances[*].InstanceId" --output text)" --priv-key C:/Ansible-keys/terraformkeypair.pem --query 'PasswordData' --output text
                        """).trim()

                        if (!password) {
                            error "Failed to decrypt password for ${ip}"
                        }

                        passwords[ip] = password
                    }

                    env.WINDOWS_PASSWORDS = passwords.collect { key, value -> "${key}:${value}" }.join(',')
                }
            }
        }

        stage('Download Scripts from S3') {
            steps {
                script {
                    echo "Downloading scripts from S3..."

                    bat "\"C:\\Program Files\\Git\\bin\\bash.exe\" -c 'AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} aws s3 cp ${S3_SCRIPT_PATH}/ConfigureRemotingForAnsible.ps1 ./'"
                    bat "\"C:\\Program Files\\Git\\bin\\bash.exe\" -c 'AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} aws s3 cp ${S3_SCRIPT_PATH}/Create_user.ps1 ./'"
                    
                    echo "Scripts downloaded successfully!"
                }
            }
        }

        stage('Execute Scripts on Windows VMs') {
            steps {
                script {
                    def ipList = env.WINDOWS_IPS.split(' ')
                    def passwordMap = env.WINDOWS_PASSWORDS.split(',').collectEntries { entry -> 
                        def (ip, pass) = entry.split(':')
                        [(ip): pass]
                    }

                    for (ip in ipList) {
                        echo "Connecting to ${ip} using WinRM..."

                        def password = passwordMap[ip]

                        def result = powershell(returnStatus: true, script: """
                            Invoke-Command -ComputerName ${ip} -Credential (New-Object System.Management.Automation.PSCredential('${ADMIN_USERNAME}', (ConvertTo-SecureString '${password}' -AsPlainText -Force))) -ScriptBlock {
                                Copy-Item -Path .\\ConfigureRemotingForAnsible.ps1 -Destination C:\\Windows\\Temp\\ConfigureRemotingForAnsible.ps1
                                Copy-Item -Path .\\Create_user.ps1 -Destination C:\\Windows\\Temp\\Create_user.ps1
                                & C:\\Windows\\Temp\\ConfigureRemotingForAnsible.ps1
                                & C:\\Windows\\Temp\\Create_user.ps1
                            }
                        """)

                        if (result != 0) {
                            error "Execution failed on ${ip}"
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            echo "Pipeline failed! Check logs for details."
        }
    }
}
